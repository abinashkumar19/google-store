name: CI/CD Full Stack Google Store

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-1
  SERVICES: "frontend backend electronics phones computers earphones"
  EC2_USER: ec2-user
  CLUSTER_NAME: abinash

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2. Configure AWS credentials
      - name: ‚öôÔ∏è Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. Login to ECR
      - name: üì¶ Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | \
            docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com

      # 4. Build Docker images and update deployment YAMLs
      - name: üê≥ Build, push, and update YAMLs
        run: |
          ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
          for service in $SERVICES; do
            echo "üõ† Processing $service ..."
            SERVICE_DIR="./$service"
            IMAGE_URI="$ACCOUNT_ID.dkr.ecr.$AWS_REGION/google-store-$service:$(date +%Y%m%d%H%M%S)"

            # Create ECR repo if not exist
            aws ecr describe-repositories --repository-names "google-store-$service" >/dev/null 2>&1 || \
              aws ecr create-repository --repository-name "google-store-$service"

            # Build & push image
            docker build -t $IMAGE_URI $SERVICE_DIR
            docker push $IMAGE_URI

            # Update deployment.yml if exists
            if [ -f "$SERVICE_DIR/deployment.yml" ]; then
              sed -i "s|image:.*|image: $IMAGE_URI|g" "$SERVICE_DIR/deployment.yml"
              echo "‚úÖ Updated deployment.yml for $service"
            fi
          done

      # 5. Configure kubectl
      - name: ‚ò∏Ô∏è Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
          kubectl config current-context

      # 6. Deploy all YAMLs
      - name: üöÄ Apply Kubernetes manifests recursively
        run: |
          for service in $SERVICES; do
            SERVICE_DIR="./$service"
            if [ -d "$SERVICE_DIR" ]; then
              echo "Applying manifests for $service ..."
              kubectl apply -f "$SERVICE_DIR" --validate=false
            fi
          done

          # Apply ingress separately if exists at root
          if [ -f "./ingress.yml" ]; then
            echo "Applying ingress.yml ..."
            kubectl apply -f ingress.yml --validate=false
          fi

      # 7. Verify deployment
      - name: ‚úÖ Verify all resources
        run: |
          kubectl get pods,svc,ingress -A
